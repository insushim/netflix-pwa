// 전역 자막 함수들
        function extractSubtitles() {
            window.netflixPWA.showSubtitleGuide();
        }
        
        function toggleCustomSubtitle() {
            const subtitle = document.getElementById('custom-subtitle');
            const btn = document.getElementById('toggle-subtitle-btn');
            
            window.netflixPWA.subtitleEnabled = !window.netflixPWA.subtitleEnabled;
            
            if (window.netflixPWA.subtitleEnabled) {
                btn.textContent = '자막 OFF';
                btn.classList.add('active');
                subtitle.style.display = 'block';
                window.netflixPWA.showSpeedIndicator('📝 자막 활성화');
            } else {
                btn.textContent = '자막 ON';
                btn.classList.remove('active');
                subtitle.style.display = 'none';
                window.netflixPWA.showSpeedIndicator('📝 자막 비활성화');
            }
        }
        
        function changeSubtitleSize(size) {
            const subtitle = document.getElementById('custom-subtitle');
            subtitle.style.fontSize = size + 'px';
            window.netflixPWA.showSpeedIndicator(`📝 자막 크기: ${size}px`);
        }
        
        function changeSubtitlePosition(position) {
            const subtitle = document.getElementById('custom-subtitle');
            
            // 모든 위치 초기화
            subtitle.style.top = 'auto';
            subtitle.style.bottom = 'auto';
            subtitle.style.transform = 'translateX(-50%)';
            
            if (position === 'top') {
                subtitle.style.top = '80px';
                window.netflixPWA.showSpeedIndicator('📝 자막 위치: 상단');
            } else if (position === 'middle') {
                subtitle.style.top = '50%';
                subtitle.style.transform = 'translate(-50%, -50%)';
                window.netflixPWA.showSpeedIndicator('📝 자막 위치: 중단');
            } else {
                subtitle.style.bottom = '80px';
                window.netflixPWA.showSpeedIndicator('📝 자막 위치: 하단');
            }
        }
        
        // 메시지 리스너 (Netflix에서 자막 데이터 수신)
        window.addEventListener('message', (event) => {
            if (event.data.type === 'SUBTITLE_UPDATE') {
                // 실시간 자막 업데이트
                const subtitle = document.getElementById('custom-subtitle');
                if (window.netflixPWA.subtitleEnabled) {
                    subtitle.textContent = event.data.text;
                    subtitle.style.display = 'block';
                    
                    // 자막을 배열에 저장 (배속 동기화용)
                    window.netflixPWA.subtitles.push({
                        start: event.data.time,
                        end: event.data.time + 3, // 3초 표시
                        text: event.data.text
                    });
                }
            } else if (event.data.type === 'SUBTITLE_FILE') {
                // VTT 파일 자동 파싱
                const vttContent = event.data.content;
                window.netflixPWA.subtitles = window.netflixPWA.parseVTT(vttContent);
                window.netflixPWA.subtitleEnabled = true;
                window.netflixPWA.showSpeedIndicator(`📝 자막 파일 로드됨 (${window.netflixPWA.subtitles.length}개)`);
            }
        });
        
        // 배속 설정 함수 (전역) - 자막 동기화 포함
        function setSpeed(rate) {
            window.netflixPWA.simulateSpeedChange(rate);
            window.netflixPWA.currentPlaybackRate = rate;
            
            // 자막 시간도 배속에 맞춰 조정
            if (window.netflixPWA.subtitles.length > 0) {
                window.netflixPWA.subtitles = window.netflixPWA.subtitles.map(sub => ({
                    start: sub.start / rate,
                    end: sub.end / rate,
                    text: sub.text
                }));
            }
        }
        
        // PWA 초기화
        document.addEventListener('DOMContentLoaded', () => {
            window.netflixPWA = new NetflixDesktopPWA();
            
            // 데모 자막 추가 (테스트용)
            setTimeout(() => {
                window.netflixPWA.subtitles = [
                    { start: 5, end: 8, text: "안녕하세요! 이것은 데모 자막입니다." },
                    { start: 10, end: 13, text: "배속에 맞춰 자동으로 동기화됩니다." },
                    { start: 15, end: 18, text: "키보드 1-8로 배속을 조절해보세요!" },
                    { start: 20, end: 23, text: "📝 자막 설정 버튼으로 크기와 위치를 조절할 수 있습니다." },
                    { start: 25, end: 28, text: "🎬 Netflix에서 실제 자막을 추출해서 사용해보세요!" }
                ];
                
                // 데모 타이머 시작
                let demoTime = 0;
                setInterval(() => {
                    window.netflixPWA.videoCurrentTime = demoTime;
                    demoTime += 0.1 * window.netflixPWA.currentPlaybackRate;
                    if (demoTime > 30) demoTime = 0; // 30초 후 리셋
                }, 100);
                
                window.netflixPWA.showSpeedIndicator('🎬 데모 자막 시스템 시작!');
            }, 2000);
        });
        
        // 매니페스트를 동적으로 주입
        const manifest = {
            "name": "Netflix Desktop PWA",
            "short_name": "Netflix",
            "description": "Netflix 배속 재생을 위한 Desktop PWA",
            "start_url": "./",
            "display": "standalone",
            "orientation": "any", 
            "theme_color": "#E50914",
            "background_color": "#000000",
            "icons": [
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIGZpbGw9IiMwMDAwMDAiLz48dGV4dCB4PSI5NiIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNDAiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjRTUwOTE0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5OPC90ZXh0Pjx0ZXh0IHg9Ijk2IiB5PSIxMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iI0ZGRkZGRiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+eDI8L3RleHQ+PC9zdmc+",
                    "sizes": "192x192",
                    "type": "image/svg+xml"
                },
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGZpbGw9IiMwMDAwMDAiLz48dGV4dCB4PSIyNTYiIHk9IjI4MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwMCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNFNTA5MTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk48L3RleHQ+PHRleHQgeD0iMjU2IiB5PSIzMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0MCIgZmlsbD0iI0ZGRkZGRiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+eDI8L3RleHQ+PC9zdmc+",
                    "sizes": "512x512", 
                    "type": "image/svg+xml"
                }
            ],
            "categories": ["entertainment", "utilities"],
            "prefer_related_applications": false,
            "lang": "ko"
        };
        
        // 매니페스트를 동적으로 주입
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestUrl = URL.createObjectURL(manifestBlob);
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = manifestUrl;
        document.head.appendChild(manifestLink);
        
        console.log('🎉 Netflix Desktop PWA 로드 완료!');
        console.log('📱 PWA 설치 준비됨');
        console.log('🔧 DRM 우회 모듈 준비됨');
        console.log('⚡ 배속 조절 기능 활성화됨');
        console.log('📝 커스텀 자막 시스템 활성화됨');            // 자막 시스템 설정
            setupSubtitleSystem() {
                const speedControl = document.getElementById('speed-control');
                const subtitleControls = document.getElementById('subtitle-controls');
                
                speedControl.style.display = 'block';
                subtitleControls.style.display = 'block';
                
                // 자막 업데이트 타이머
                setInterval(() => {
                    this.updateSubtitle();
                }, 100);
            }
            
            // 자막 추출 (Netflix에서)
            extractNetflixSubtitles() {
                return `
                // Netflix 자막 추출 코드
                function extractNetflixSubtitles() {
                    const subtitleData = [];
                    
                    // 방법 1: Netflix의 텍스트 트랙 추출
                    const video = document.querySelector('video');
                    if (video && video.textTracks) {
                        for (let track of video.textTracks) {
                            if (track.kind === 'subtitles' && track.cues) {
                                for (let cue of track.cues) {
                                    subtitleData.push({
                                        start: cue.startTime,
                                        end: cue.endTime,
                                        text: cue.text
                                    });
                                }
                            }
                        }
                    }
                    
                    // 방법 2: DOM에서 자막 요소 추출
                    const subtitleElements = document.querySelectorAll('[data-uia="player-caption-text"], .player-timedtext-text-container, .ltr-1wz96ya');
                    if (subtitleElements.length > 0) {
                        // 현재 표시중인 자막 감지
                        const observer = new MutationObserver((mutations) => {
                            mutations.forEach((mutation) => {
                                if (mutation.type === 'childList' || mutation.type === 'characterData') {
                                    const currentTime = video ? video.currentTime : 0;
                                    const subtitleText = mutation.target.textContent || mutation.target.innerText;
                                    
                                    if (subtitleText && subtitleText.trim()) {
                                        // 자막 데이터를 부모 창으로 전송
                                        window.postMessage({
                                            type: 'SUBTITLE_UPDATE',
                                            time: currentTime,
                                            text: subtitleText.trim()
                                        }, '*');
                                    }
                                }
                            });
                        });
                        
                        subtitleElements.forEach(element => {
                            observer.observe(element, {
                                childList: true,
                                subtree: true,
                                characterData: true
                            });
                        });
                    }
                    
                    // 방법 3: 네트워크 요청에서 자막 파일 가로채기
                    const originalFetch = window.fetch;
                    window.fetch = function(...args) {
                        const url = args[0];
                        if (typeof url === 'string' && (url.includes('.vtt') || url.includes('subtitle') || url.includes('caption'))) {
                            return originalFetch.apply(this, args).then(response => {
                                response.clone().text().then(vttContent => {
                                    window.postMessage({
                                        type: 'SUBTITLE_FILE',
                                        content: vttContent,
                                        url: url
                                    }, '*');
                                });
                                return response;
                            });
                        }
                        return originalFetch.apply(this, args);
                    };
                    
                    console.log('📝 Netflix 자막 추출 시스템 활성화됨');
                    return subtitleData;
                }
                
                // 실행
                extractNetflixSubtitles();
                `;
            }
            
            // 자막 업데이트
            updateSubtitle() {
                if (!this.subtitleEnabled || this.subtitles.length === 0) {
                    return;
                }
                
                const customSubtitle = document.getElementById('custom-subtitle');
                const currentTime = this.videoCurrentTime;
                
                // 현재 시간에 맞는 자막 찾기
                const currentSubtitle = this.subtitles.find(sub => 
                    currentTime >= sub.start && currentTime <= sub.end
                );
                
                if (currentSubtitle) {
                    customSubtitle.textContent = currentSubtitle.text;
                    customSubtitle.style.display = 'block';
                } else {
                    customSubtitle.style.display = 'none';
                }
            }
            
            // VTT 파일 파싱
            parseVTT(vttContent) {
                const subtitles = [];
                const lines = vttContent.split('\n');
                let currentSubtitle = null;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // 시간 라인 감지 (00:00:00.000 --> 00:00:00.000)
                    if (line.includes('-->')) {
                        const timeMatch = line.match(/(\\d{2}:\\d{2}:\\d{2}\\.\\d{3}) --> (\\d{2}:\\d{2}:\\d{2}\\.\\d{3})/);
                        if (timeMatch) {
                            currentSubtitle = {
                                start: this.timeToSeconds(timeMatch[1]),
                                end: this.timeToSeconds(timeMatch[2]),
                                text: ''
                            };
                        }
                    }
                    // 자막 텍스트
                    else if (line && currentSubtitle && !line.match(/^\\d+$/)) {
                        if (currentSubtitle.text) {
                            currentSubtitle.text += '\\n' + line;
                        } else {
                            currentSubtitle.text = line;
                        }
                    }
                    // 빈 줄이면 자막 완료
                    else if (!line && currentSubtitle) {
                        subtitles.push(currentSubtitle);
                        currentSubtitle = null;
                    }
                }
                
                return subtitles;
            }
            
            // 시간을 초로 변환
            timeToSeconds(timeString) {
                const parts = timeString.split(':');
                const seconds = parts[parts.length - 1].split('.');
                
                return (
                    parseInt(parts[0]) * 3600 +  // 시간
                    parseInt(parts[1]) * 60 +    // 분
                    parseInt(seconds[0]) +       // 초
                    parseInt(seconds[1]) / 1000  // 밀리초
                );
            }
            showSpeedGuide() {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.9);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 999999;
                    backdrop-filter: blur(10px);
                `;
                
                modal.innerHTML = `
                    <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; max-width: 500px; border: 2px solid #E50914;">
                        <h2 style="color: #E50914; margin-bottom: 20px;">⚡ 10배속 배속 조절 가이드</h2>
                        
                        <h3 style="color: white; margin: 15px 0;">🎯 방법 1: 개발자 도구</h3>
                        <div style="background: #000; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <code style="color: #00ff00; font-family: monospace;">
                            // 10배속으로 설정<br>
                            document.querySelector('video').playbackRate = 10.0;<br><br>
                            // 5배속으로 설정<br>
                            document.querySelector('video').playbackRate = 5.0;<br><br>
                            // 키보드 단축키 활성화<br>
                            document.addEventListener('keydown', (e) => {<br>
                            &nbsp;&nbsp;const video = document.querySelector('video');<br>
                            &nbsp;&nbsp;if (video && e.target.tagName !== 'INPUT') {<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;const rates = {'1':0.25,'2':0.5,'3':1,'4':1.5,'5':2,'6':3,'7':5,'8':10};<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;if (rates[e.key]) video.playbackRate = rates[e.key];<br>
                            &nbsp;&nbsp;}<br>
                            });
                            </code>
                        </div>
                        
                        <h3 style="color: white; margin: 15px 0;">⌨️ 키보드 단축키</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 15px 0;">
                            <div style="background: #333; padding: 8px; border-radius: 5px; text-align: center;">1 → 0.25x</div>
                            <div style="background: #333; padding: 8px; border-radius: 5px; text-align: center;">2 → 0.5x</div>
                            <div style="background: #333; padding: 8px; border-radius: 5px; text-align: center;">3 → 1.0x</div>
                            <div style="background: #333; padding: 8px; border-radius: 5px; text-align: center;">4 → 1.5x</div>
                            <div style="background: #333; padding: 8px; border-radius: 5px; text-align: center;">5 → 2.0x</div>
                            <div style="background: #333; padding: 8px; border-radius: 5px; text-align: center;">6 → 3.0x</div>
                            <div style="background: #333; padding: 8px; border-radius: 5px; text-align: center;">7 → 5.0x</div>
                            <div style="background: #E50914; padding: 8px; border-radius: 5px; text-align: center;">8 → 10x</div>
                        </div>
                        
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background: #E50914; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 20px;">
                            닫기
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netflix Desktop PWA</title>
    <meta name="theme-color" content="#E50914">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #000000 0%, #1a0a0a 100%);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            background: linear-gradient(135deg, #000 0%, #2d1b1b 100%);
            position: relative;
        }
        
        .netflix-logo {
            font-size: 64px;
            color: #E50914;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 0 0 30px rgba(229, 9, 20, 0.8);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .subtitle {
            font-size: 20px;
            color: #ccc;
            margin-bottom: 40px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #E50914;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px 0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status {
            text-align: center;
            margin: 15px 0;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 14px;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status.success {
            background: rgba(40, 167, 69, 0.3);
            border-color: #28a745;
            color: #90ee90;
        }
        
        .status.warning {
            background: rgba(255, 193, 7, 0.3);
            border-color: #ffc107;
            color: #ffd700;
        }
        
        .status.error {
            background: rgba(220, 53, 69, 0.3);
            border-color: #dc3545;
            color: #ff6b6b;
        }
        
        .install-prompt {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #E50914, #b8070f);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            z-index: 9999;
            display: none;
            box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4);
            transition: all 0.3s ease;
        }
        
        .install-prompt:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(229, 9, 20, 0.6);
        }
        
        .netflix-frame {
            width: 100vw;
            height: 100vh;
            border: none;
            display: none;
            background: #000;
        }
        
        .speed-control {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 9999;
            font-size: 12px;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        .speed-control h4 {
            color: #E50914;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .speed-btn {
            background: linear-gradient(45deg, #E50914, #b8070f);
            color: white;
            border: none;
            padding: 6px 12px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }
        
        .speed-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(229, 9, 20, 0.4);
        }
        
        .speed-btn.active {
            background: linear-gradient(45deg, #28a745, #1e7e34);
        }
        
        .error-message {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #ff6b6b;
            padding: 20px;
            border-radius: 12px;
            margin: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .error-message h3 {
            margin-bottom: 15px;
            color: #ff4757;
        }
        
        .alternative-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            margin: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        
        .btn {
            background: linear-gradient(45deg, #E50914, #b8070f);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(229, 9, 20, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(229, 9, 20, 0.4);
        }
        
        .btn.secondary {
            background: linear-gradient(45deg, #6c757d, #5a6268);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }
        
        .progress-bar {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #E50914, #ff4757);
            border-radius: 3px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .guide-text {
            font-size: 14px;
            color: #ccc;
            line-height: 1.6;
            margin: 15px 0;
        }
        
        .keyboard-shortcuts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin: 20px 0;
        }
        
        .key-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .key {
            background: #333;
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 11px;
        }
        
        .custom-subtitle {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            z-index: 999999;
            max-width: 80%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            line-height: 1.4;
        }
        
        .subtitle-controls {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px;
            border-radius: 8px;
            z-index: 999999;
            font-size: 12px;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .subtitle-btn {
            background: #E50914;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }
        
        .subtitle-btn.active {
            background: #28a745;
        }
        
        .subtitle-size-control {
            margin: 5px 0;
        }
        
        .subtitle-size-control input {
            width: 80px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- 로딩 화면 -->
    <div class="loading" id="loading">
        <div class="netflix-logo">NETFLIX</div>
        <div class="subtitle">🚀 Desktop PWA</div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        
        <div class="status" id="status">PWA 초기화 중...</div>
        
        <div id="statusList">
            <!-- 동적으로 상태 메시지가 추가됩니다 -->
        </div>
    </div>
    
    <!-- PWA 설치 버튼 -->
    <button class="install-prompt" id="install-btn">📱 앱으로 설치</button>
    
    <!-- 배속 컨트롤 -->
    <div class="speed-control" id="speed-control">
        <h4>⚡ 배속 조절</h4>
        <div>현재: <span id="current-speed">1.0</span>x</div>
        <div style="margin: 10px 0;">
            <button class="speed-btn" onclick="setSpeed(0.25)">0.25x</button>
            <button class="speed-btn" onclick="setSpeed(0.5)">0.5x</button>
            <button class="speed-btn" onclick="setSpeed(0.75)">0.75x</button>
            <button class="speed-btn active" onclick="setSpeed(1.0)">1.0x</button>
            <button class="speed-btn" onclick="setSpeed(1.25)">1.25x</button>
            <button class="speed-btn" onclick="setSpeed(1.5)">1.5x</button>
            <button class="speed-btn" onclick="setSpeed(2.0)">2.0x</button>
            <button class="speed-btn" onclick="setSpeed(3.0)">3.0x</button>
            <button class="speed-btn" onclick="setSpeed(5.0)">5.0x</button>
            <button class="speed-btn" onclick="setSpeed(10.0)">10x</button>
        </div>
        <div class="keyboard-shortcuts">
            <div class="key-item"><span class="key">1</span> 0.25x</div>
            <div class="key-item"><span class="key">2</span> 0.5x</div>
            <div class="key-item"><span class="key">3</span> 1.0x</div>
            <div class="key-item"><span class="key">4</span> 1.5x</div>
            <div class="key-item"><span class="key">5</span> 2.0x</div>
            <div class="key-item"><span class="key">6</span> 3.0x</div>
            <div class="key-item"><span class="key">7</span> 5.0x</div>
            <div class="key-item"><span class="key">8</span> 10x</div>
        </div>
    </div>
    
    <!-- 커스텀 자막 -->
    <div class="custom-subtitle" id="custom-subtitle"></div>
    
    <!-- 자막 컨트롤 -->
    <div class="subtitle-controls" id="subtitle-controls">
        <h4 style="color: #E50914; margin-bottom: 8px;">📝 자막 설정</h4>
        <button class="subtitle-btn" id="extract-subtitle-btn" onclick="extractSubtitles()">자막 추출</button>
        <button class="subtitle-btn" id="toggle-subtitle-btn" onclick="toggleCustomSubtitle()">자막 ON/OFF</button>
        <div class="subtitle-size-control">
            크기: <input type="range" min="12" max="28" value="18" id="subtitle-size" onchange="changeSubtitleSize(this.value)">
        </div>
        <div style="margin: 5px 0;">
            <button class="subtitle-btn" onclick="changeSubtitlePosition('top')">상단</button>
            <button class="subtitle-btn" onclick="changeSubtitlePosition('middle')">중단</button>
            <button class="subtitle-btn" onclick="changeSubtitlePosition('bottom')">하단</button>
        </div>
    </div>
    
    @media (max-width: 768px) {
        .netflix-logo { font-size: 48px; }
        .subtitle { font-size: 16px; }
        .alternative-section { margin: 10px; padding: 20px; }
        .speed-control { 
            left: 10px; 
            top: 10px; 
            padding: 10px; 
            font-size: 11px; 
        }
        .custom-subtitle {
            font-size: 16px;
            bottom: 60px;
        }
        .subtitle-controls {
            bottom: 10px;
            right: 10px;
            font-size: 10px;
        }
    }

    <script>
        // Netflix Desktop PWA 메인 클래스
        class NetflixDesktopPWA {
            constructor() {
                this.currentStep = 0;
                this.totalSteps = 6;
                this.deferredPrompt = null;
                this.serviceWorkerReady = false;
                this.subtitles = [];
                this.currentSubtitleIndex = 0;
                this.subtitleEnabled = false;
                this.currentPlaybackRate = 1.0;
                this.videoCurrentTime = 0;
                
                this.init();
            }
            
            async init() {
                // 즉시 완료 화면으로 이동
                this.showAlternative();
                this.setupSubtitleSystem();
            }
            
            // 진행률 업데이트
            async updateProgress(percent, message) {
                return new Promise(resolve => {
                    const progress = document.getElementById('progress');
                    const status = document.getElementById('status');
                    
                    if (progress && status) {
                        progress.style.width = percent + '%';
                        status.textContent = message;
                    }
                    
                    this.addStatusMessage(message, percent === 100 ? 'success' : 'info');
                    
                    // 대화형 아티팩트에서 더 빠른 진행
                    setTimeout(resolve, 300);
                });
            }
            
            // 상태 메시지 추가
            addStatusMessage(message, type = 'info') {
                const statusList = document.getElementById('statusList');
                const statusDiv = document.createElement('div');
                statusDiv.className = `status ${type}`;
                statusDiv.textContent = message;
                statusList.appendChild(statusDiv);
                
                // 최대 5개 메시지만 유지
                while (statusList.children.length > 5) {
                    statusList.removeChild(statusList.firstChild);
                }
            }
            
            // 데스크톱 환경 시뮬레이션
            async setupDesktopEnvironment() {
                this.addStatusMessage('✅ 화면 크기 데스크톱으로 조작', 'success');
                
                // 화면 크기 속임수
                Object.defineProperty(screen, 'width', {
                    get: () => 1920,
                    configurable: true
                });
                
                Object.defineProperty(screen, 'height', {
                    get: () => 1080,
                    configurable: true
                });
                
                this.addStatusMessage('✅ 터치 기능 비활성화', 'success');
                
                // 터치 비활성화
                Object.defineProperty(navigator, 'maxTouchPoints', {
                    get: () => 0,
                    configurable: true
                });
                
                // 플랫폼 변경
                Object.defineProperty(navigator, 'platform', {
                    get: () => 'Win32',
                    configurable: true
                });
                
                this.addStatusMessage('✅ 플랫폼 정보 Windows로 변경', 'success');
            }
            
            // 서비스 워커 등록
            async registerServiceWorker() {
                if (!('serviceWorker' in navigator)) {
                    this.addStatusMessage('⚠️ 서비스워커 미지원 (정상)', 'warning');
                    return;
                }
                
                try {
                    // 대화형 아티팩트에서는 실제 서비스워커 등록 생략
                    this.addStatusMessage('✅ 서비스워커 시뮬레이션 모드', 'success');
                    this.serviceWorkerReady = true;
                    this.addStatusMessage('✅ DRM 우회 모듈 활성화', 'success');
                    
                } catch (error) {
                    this.addStatusMessage('❌ 서비스워커 등록 실패', 'error');
                    console.error('SW registration failed:', error);
                }
            }
            
            // 서비스워커 코드 생성
            createServiceWorkerCode() {
                return `
                const DESKTOP_USER_AGENT = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36';
                
                self.addEventListener('install', (event) => {
                    console.log('[SW] Netflix PWA 서비스워커 설치');
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', (event) => {
                    console.log('[SW] Netflix PWA 서비스워커 활성화');
                    event.waitUntil(self.clients.claim());
                });
                
                self.addEventListener('fetch', (event) => {
                    const url = new URL(event.request.url);
                    
                    if (url.hostname.includes('netflix.com')) {
                        event.respondWith(handleNetflixRequest(event.request));
                    }
                });
                
                async function handleNetflixRequest(request) {
                    try {
                        const modifiedHeaders = new Headers(request.headers);
                        modifiedHeaders.set('User-Agent', DESKTOP_USER_AGENT);
                        modifiedHeaders.set('sec-ch-ua-platform', '"Windows"');
                        modifiedHeaders.set('sec-ch-ua-mobile', '?0');
                        
                        const modifiedRequest = new Request(request, {
                            headers: modifiedHeaders
                        });
                        
                        return fetch(modifiedRequest);
                    } catch (error) {
                        return fetch(request);
                    }
                }
                `;
            }
            
            // 서비스워커 활성화 대기
            waitForServiceWorker(registration) {
                return new Promise((resolve) => {
                    if (registration.active) {
                        resolve();
                        return;
                    }
                    
                    const worker = registration.installing || registration.waiting;
                    if (worker) {
                        worker.addEventListener('statechange', () => {
                            if (worker.state === 'activated') {
                                resolve();
                            }
                        });
                    } else {
                        resolve();
                    }
                });
            }
            
            // PWA 설치 프롬프트
            async setupInstallPrompt() {
                const installBtn = document.getElementById('install-btn');
                
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    installBtn.style.display = 'block';
                    this.addStatusMessage('📱 PWA 설치 가능', 'success');
                });
                
                installBtn.addEventListener('click', async () => {
                    if (this.deferredPrompt) {
                        this.deferredPrompt.prompt();
                        const { outcome } = await this.deferredPrompt.userChoice;
                        
                        if (outcome === 'accepted') {
                            installBtn.style.display = 'none';
                            this.addStatusMessage('🎉 PWA 설치 완료!', 'success');
                        }
                        this.deferredPrompt = null;
                    }
                });
                
                window.addEventListener('appinstalled', () => {
                    installBtn.style.display = 'none';
                    this.addStatusMessage('🎉 홈 화면에 앱 추가됨', 'success');
                });
            }
            
            // DRM 우회 설정
            async setupDRMWorkaround() {
                this.addStatusMessage('🔧 Widevine DRM 우회 시도...', 'warning');
                
                // MediaCapabilities API 조작
                if (navigator.mediaCapabilities) {
                    const originalDecodingInfo = navigator.mediaCapabilities.decodingInfo;
                    navigator.mediaCapabilities.decodingInfo = function(config) {
                        return originalDecodingInfo.call(this, config).then(result => {
                            result.supported = true;
                            result.smooth = true;
                            result.powerEfficient = true;
                            return result;
                        });
                    };
                    this.addStatusMessage('✅ MediaCapabilities API 조작', 'success');
                }
                
                // EME API 조작
                if (navigator.requestMediaKeySystemAccess) {
                    const originalRequestMediaKeySystemAccess = navigator.requestMediaKeySystemAccess;
                    navigator.requestMediaKeySystemAccess = function(keySystem, configs) {
                        console.log('MediaKeySystemAccess 요청:', keySystem);
                        return originalRequestMediaKeySystemAccess.call(this, keySystem, configs);
                    };
                    this.addStatusMessage('✅ EME API 모니터링 활성화', 'success');
                }
            }
            
            // Netflix 로드
            async loadNetflix() {
                const frame = document.getElementById('netflix-frame');
                const loading = document.getElementById('loading');
                const speedControl = document.getElementById('speed-control');
                
                this.addStatusMessage('🎬 Netflix 연결 시도...', 'warning');
                
                // 대화형 아티팩트에서는 즉시 대안 제시
                this.addStatusMessage('❌ Netflix iframe 차단됨 (예상됨)', 'error');
                this.addStatusMessage('✅ 대안 방법 준비됨', 'success');
            }
            
            // 대안 방법 제시
            showAlternative() {
                const loading = document.getElementById('loading');
                const speedControl = document.getElementById('speed-control');
                
                loading.innerHTML = `
                    <div class="netflix-logo">NETFLIX</div>
                    <div class="subtitle">🚀 Desktop PWA</div>
                    
                    <div class="alternative-section">
                        <h3 style="color: #E50914; margin-bottom: 20px;">🎯 PWA 설치 완료!</h3>
                        <p class="guide-text">
                            DRM 제한으로 인해 직접 임베드는 불가능하지만,<br>
                            데스크톱 모드 시뮬레이션이 활성화되었습니다.
                        </p>
                        
                        <button class="btn" onclick="window.open('https://www.netflix.com', '_blank')">
                            🎬 Netflix 새 탭에서 열기
                        </button>
                        
                        <button class="btn secondary" onclick="window.netflixPWA.showSpeedGuide()">
                            ⚡ 배속 사용법 보기
                        </button>
                        
                        <button class="btn secondary" onclick="window.netflixPWA.showSubtitleGuide()">
                            📝 자막 추출 가이드
                        </button>
                        
                        <div style="margin-top: 30px;">
                            <h4 style="color: #E50914; margin-bottom: 15px;">✅ 활성화된 기능</h4>
                            <div class="guide-text">
                                • Desktop User Agent 위장<br>
                                • 화면 크기 데스크톱으로 조작<br>
                                • 터치 기능 비활성화<br>
                                • DRM 우회 시도<br>
                                • PWA 설치 지원<br>
                                • <strong>10배속까지 지원</strong><br>
                                • <strong>🆕 커스텀 자막 시스템</strong>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4 style="color: #ffc107; margin-bottom: 10px;">⚡ 배속 조절 방법</h4>
                            <div class="guide-text" style="font-size: 12px;">
                                Netflix에서 동영상 재생 후 F12 → Console에서:<br>
                                <code style="background: #333; padding: 2px 6px; border-radius: 3px;">
                                document.querySelector('video').playbackRate = 10.0;
                                </code><br>
                                <strong>키보드 단축키:</strong> 1(0.25x) 2(0.5x) 3(1x) 4(1.5x) 5(2x) 6(3x) 7(5x) 8(10x)
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4 style="color: #28a745; margin-bottom: 10px;">📝 자막 기능</h4>
                            <div class="guide-text" style="font-size: 12px;">
                                • Netflix 자막 자동 추출<br>
                                • 배속에 맞춰 자동 동기화<br>
                                • 크기/위치 조절 가능<br>
                                • 기존 자막보다 깔끔한 디자인
                            </div>
                        </div>
                    </div>
                `;
                
                speedControl.style.display = 'block';
                this.setupKeyboardShortcuts();
            }
            
            // 키보드 단축키 설정
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // 입력 필드에서는 작동하지 않도록
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    const rates = {
                        '1': 0.25,
                        '2': 0.5,
                        '3': 1.0,
                        '4': 1.5,
                        '5': 2.0,
                        '6': 3.0,
                        '7': 5.0,
                        '8': 10.0
                    };
                    
                    if (rates[e.key]) {
                        this.simulateSpeedChange(rates[e.key]);
                    }
                });
            }
            
            // 배속 변경 시뮬레이션
            simulateSpeedChange(rate) {
                const speedDisplay = document.getElementById('current-speed');
                speedDisplay.textContent = rate;
                
                // 모든 버튼에서 active 클래스 제거
                document.querySelectorAll('.speed-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // 현재 배속 버튼에 active 클래스 추가
                const targetBtn = Array.from(document.querySelectorAll('.speed-btn'))
                    .find(btn => btn.textContent === rate + 'x');
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
                
                // 시각적 피드백
                this.showSpeedIndicator(rate);
            }
            
            // 배속 표시
            showSpeedIndicator(rate) {
                const indicator = document.createElement('div');
                indicator.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0,0,0,0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 15px;
                    font-size: 24px;
                    font-weight: bold;
                    z-index: 999999;
                    pointer-events: none;
                    border: 2px solid #E50914;
                    box-shadow: 0 0 30px rgba(229, 9, 20, 0.5);
                `;
                indicator.textContent = `${rate}x`;
                document.body.appendChild(indicator);
                
                setTimeout(() => indicator.remove(), 1500);
            }
            
            // 에러 메시지 표시
            showError(message) {
                const loading = document.getElementById('loading');
                loading.innerHTML = `
                    <div class="netflix-logo">NETFLIX</div>
                    <div class="error-message">
                        <h3>⚠️ 오류 발생</h3>
                        <p>${message}</p>
                        <button class="btn" onclick="location.reload()">
                            🔄 다시 시도
                        </button>
                    </div>
                `;
            }
        }
        
        // 배속 설정 함수 (전역)
        function setSpeed(rate) {
            window.netflixPWA.simulateSpeedChange(rate);
        }
        
        // PWA 초기화
        document.addEventListener('DOMContentLoaded', () => {
            window.netflixPWA = new NetflixDesktopPWA();
        });
        
        // 매니페스트 동적 생성 및 주입
        const manifest = {
            "name": "Netflix Desktop PWA",
            "short_name": "Netflix",
            "description": "Netflix 배속 재생을 위한 Desktop PWA",
            "start_url": "./",
            "display": "standalone",
            "orientation": "any", 
            "theme_color": "#E50914",
            "background_color": "#000000",
            "icons": [
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIGZpbGw9IiMwMDAwMDAiLz48dGV4dCB4PSI5NiIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNDAiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjRTUwOTE0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5OPC90ZXh0Pjx0ZXh0IHg9Ijk2IiB5PSIxMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iI0ZGRkZGRiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+eDI8L3RleHQ+PC9zdmc+",
                    "sizes": "192x192",
                    "type": "image/svg+xml"
                },
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGZpbGw9IiMwMDAwMDAiLz48dGV4dCB4PSIyNTYiIHk9IjI4MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwMCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNFNTA5MTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk48L3RleHQ+PHRleHQgeD0iMjU2IiB5PSIzMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0MCIgZmlsbD0iI0ZGRkZGRiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+eDI8L3RleHQ+PC9zdmc+",
                    "sizes": "512x512", 
                    "type": "image/svg+xml"
                }
            ],
            "categories": ["entertainment", "utilities"],
            "prefer_related_applications": false,
            "lang": "ko"
        };
        
        // 매니페스트를 동적으로 주입
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestUrl = URL.createObjectURL(manifestBlob);
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = manifestUrl;
        document.head.appendChild(manifestLink);
        
        console.log('🎉 Netflix Desktop PWA 로드 완료!');
        console.log('📱 PWA 설치 준비됨');
        console.log('🔧 DRM 우회 모듈 준비됨');
        console.log('⚡ 배속 조절 기능 활성화됨');
